# 技术实现

## I 信息录入

### 1. txt录入

利用`QTextStream`流式读入。

```cpp
QTextStream in(&file);
QString info = in.readAll();
```

### 2. PDF录入
在`PDFReader::read`类方法中读入PDF
```c++
    const auto pdfDoc = new QPdfDocument();
    pdfDoc->load(filepath);
    QString info;
    for (int pageIndex = 0; pageIndex < pdfDoc->pageCount(); ++pageIndex) {
        QPdfSelection page = pdfDoc->getAllText(pageIndex);
        QString text = page.text();
        if(!text.isEmpty())
            info.append(text + "\n");
    }
    delete pdfDoc;
    if(info.isEmpty())
        return PicReader::read(filepath);
	return info;
```
利用`QPdfDocument`逐页提取其中文字，如果最后发现文字总数为0，则说明PDF可能为图片型，将路径交由图片处理器中处理
在`PicReader::read`中利用`QPdfDocument::render`获取对应的`QImage`，并且交由nlp接口进行读取
### 3. JPG/PNG录入
利用`PicReader::read`，分别将图片打开为`QImage`格式，调用`parser::parserImage`获取`QImage`对象对应的所有字符串
### 4. DOXC录入


## II 个人信息解析

`parserInfo.cpp` 实现了所有个人信息解析的函数，定义在命名空间 `parser` 中。

### 1. 姓名解析

使用Cmss实体识别接口，提取其中type为 `PER` 的word。

```cpp
QJsonValue itemsValue = entityJson["body"]["items"];
QJsonArray itemsArray = itemsValue.toArray();
for (int j = 0; j < itemsArray.count(); ++j) {
    QJsonArray nerTokens = itemsArray.at(j)["nerTokens"].toArray();
    for (int k = 0; k < nerTokens.count(); ++k) {
        if (nerTokens.at(k)["type"].toString().contains("PER")) {
            return nerTokens.at(k)["word"].toString();
        }
    }
}
```

### 2. 年龄

使用正则表达式匹配。

```cpp
const QRegularExpression directRegExp(R"((\d+)\s*(岁|周岁))");
const QRegularExpression indirectRegExp(R"(\d{4}(?:\.|年|/|、))");
const QRegularExpression invalidRegExp(R"([1-5][8-9]|[2-5][0-9]|[6][0-5])");
```

### 3. 学历

使用字典搜索学历。

```cpp
QStringList educationList = { "博士", "硕士", "本科", "学士", "大专", "专科", "中专", "职业学院", "职业学校" , "职业技术学院", "职业技术学校", "高中"};
QString highestEducation = "unknown";

QString removeSpaceContent = content;
removeSpaceContent.replace(" ", "");
for (const auto& education : educationList) {
    if (removeSpaceContent.contains(education)) {
        if (education == "职业学院" || education == "职业学校" || education == "大专" || 
            education == "职业技术学校" || education == "职业技术学院") {
            highestEducation = "专科";
        }
        else if (education == "学士") {
            highestEducation = "本科";
        }
        else {
            highestEducation = education;
        }
        break;
    }
}
```

### 4. 毕业院校

使用Cmss实体识别接口，提取其中type为 `ORG` 的word。

```cpp
QJsonValue itemsValue = entityJson["body"]["items"];
QJsonArray itemsArray = itemsValue.toArray();
for (int j = 0; j < itemsArray.count(); ++j) {
    QJsonArray nerTokens = itemsArray.at(j)["nerTokens"].toArray();
    for (int k = 0; k < nerTokens.count(); ++k) {
        if (nerTokens.at(k)["type"].toString().contains("ORG")) {
            QString org = nerTokens.at(k)["word"].toString();
            if (org.contains("大学") || 
                org.contains("学院") ||
                org.contains("学校")) {
                return org;
            }
        }
    }
}
```

### 5. 工作年限

使用正则表达式匹配时间段，计算时间间隔总和。

```cpp
const QRegularExpression directRegex(
    R"([^\d](\d){1,2}(?:年.*?(?!实习)经(验|历)))"
);
```

```cpp
long long years = 0;
foreach(const auto & interval, intervals) {
    const QDate start = interval.first;
    const QDate end = interval.second;
    const auto count = start.daysTo(end) / 365ll;
    if (count > 0 && count < 40)
        years += count;
}
```

```cpp
const auto years =
    parserWorkYearsHelper(removeSpaceContent,
        QRegularExpression(R"((\d{4}(?:.|年|/|、)\d{1,2})(?:-|–|到|至)(\d{4}(?:.|年|/|、)\d{1,2}))"))
    +
    parserWorkYearsHelper(removeSpaceContent,
        QRegularExpression(R"((\d{4}(?:.|年|/|、)\d{1,2})(?:-|–|到|至)?(至今))"))
    +
    parserWorkYearsHelper(removeSpaceContent,
        QRegularExpression(R"((\d{4})(?:.|年)?(?:-|–|到|至)(\d{4})(?:.|年)?)"))
    +
    parserWorkYearsHelper(removeSpaceContent,
        QRegularExpression(R"((\d{4})(?:.|年)?(?:-|–|到|至)?(至今))"));
```

## III 全部信息解析

`excelwriter.cpp` 和 `allanalyse.cpp` 实现了全部信息解析

### 1. 数据可视化

饼图

```cpp
const auto pieSeries = new QPieSeries(this);
pieSeries->setHoleSize(0.35);

const auto data = handleData(contents);
for (auto it = data.constKeyValueBegin(); it != data.constKeyValueEnd(); ++it) {
    writeDataToPieChart(pieSeries, it->first, it->second, std::distance(data.constKeyValueBegin(), it));
}

const auto chart = new QChart;
chart->setTitle("学历分布");
chart->setTitleFont(QFont("微软雅黑", 12));
chart->addSeries(pieSeries);
chart->setAnimationOptions(QChart::SeriesAnimations);
chart->legend()->setVisible(false);
ui->eduChartView->setRenderHint(QPainter::Antialiasing);
ui->eduChartView->setRenderHint(QPainter::NonCosmeticBrushPatterns);
ui->eduChartView->setChart(chart);
```

柱形图

```cpp
const auto set = new QBarSet("SET", this);

int group[] = { 0, 0, 0, 0 };

// handle group

*set << group[0] << group[1] << group[2] << group[3];
set->setColor(QColor::fromString(getColor(0)));

const auto series = new QBarSeries(this);
series->append(set);

// create categories

const auto chart = new QChart;
chart->setAnimationOptions(QChart::SeriesAnimations);
chart->legend()->setVisible(false);
chart->addSeries(series);

chart->createDefaultAxes();

const auto axisX = new QBarCategoryAxis(this);
axisX->append(categories);
series->attachAxis(axisX);
chart->setAxisX(axisX, series);

const int maxNum = *std::max_element(group, group + 4);
const auto axisY = new QValueAxis(this);
axisY->setRange(0, maxNum);
axisY->setTickCount(maxNum + 1);
axisY->setLabelFormat("%d");
chart->setAxisY(axisY);

ui->ageChartView->setChart(chart);
ui->ageChartView->setRenderHint(QPainter::Antialiasing);
```

### 2. Excel输出

```cpp
const auto progressDialog =
    new QProgressDialog("结果生成中", nullptr, 0, contents.size(), nullptr, Qt::CustomizeWindowHint);
progressDialog->setWindowModality(Qt::ApplicationModal);
progressDialog->show();

int status = 0;
setCellValue(1, 1, QStringLiteral("简历文件名"));
setCellValue(1, 2, QStringLiteral("姓名"));
setCellValue(1, 3, QStringLiteral("年龄"));
setCellValue(1, 4, QStringLiteral("最高学历"));
setCellValue(1, 5, QStringLiteral("毕业院校"));
setCellValue(1, 6, QStringLiteral("工作年限"));
setCellValue(1, 7, QStringLiteral("匹配岗位"));
for (int row = 2; row < contents.size() + 2; ++row) {
    for (int col = 1; col < 8; ++col) {
        setCellValue(row, col, contents[row - 2][col - 1]);
        progressDialog->setValue(status++);
        progressDialog->setWindowModality(Qt::ApplicationModal);
    }
}
```

```cpp
void ExcelWriter::setCellValue(int row, int column, const QString& value) {
    QAxObject* pRange = pSheet->querySubObject("Cells(int,int)", row, column);
    pRange->dynamicCall("Value", value);
}
```

## IV 人岗匹配